import urllib.request
import json
import ssl

# â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…
API_KEY = "AIzaSyC93wpAHbYeKrfVgEAF9DkIFi2OAC33lJM" 

def list_and_test_models():
    # æ­¥é©Ÿ 1: è©¢å• Google æœ‰å“ªäº›æ¨¡å‹å¯ç”¨ (List Models)
    list_url = f"https://generativelanguage.googleapis.com/v1beta/models?key={API_KEY}"
    headers = {'Content-Type': 'application/json'}
    context = ssl._create_unverified_context()

    print("ğŸ” æ­£åœ¨æŸ¥è©¢æ‚¨çš„ API Key å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨...")
    
    try:
        req = urllib.request.Request(list_url, headers=headers, method='GET')
        with urllib.request.urlopen(req, context=context) as response:
            data = json.loads(response.read().decode('utf-8'))
            
        available_models = []
        print("\nğŸ“‹ Google å›å‚³çš„æ¨¡å‹æ¸…å–®ï¼š")
        
        if 'models' not in data:
            print("âš ï¸ è­¦å‘Šï¼šå›å‚³è³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ° 'models' æ¬„ä½ã€‚")
            print(json.dumps(data, indent=2))
            return

        for model in data['models']:
            # åªæ‰¾æ”¯æ´ 'generateContent' (å°è©±ç”Ÿæˆ) çš„æ¨¡å‹
            if 'generateContent' in model.get('supportedGenerationMethods', []):
                name = model['name'] # æ ¼å¼é€šå¸¸æ˜¯ models/gemini-pro
                print(f"  - {name}")
                available_models.append(name)
        
        if not available_models:
            print("\nâŒ éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿä¼¼ä¹æ²’æœ‰ä»»ä½•å¯ç”¨æ–¼ã€Œæ–‡å­—ç”Ÿæˆã€çš„æ¨¡å‹æ¬Šé™ã€‚")
            print("è«‹ç¢ºèª Google Cloud Console ä¸­æ˜¯å¦å·²å•Ÿç”¨ 'Generative Language API'ã€‚")
            return

        # æ­¥é©Ÿ 2: è‡ªå‹•æŒ‘é¸ä¸€å€‹æ¨¡å‹ä¾†æ¸¬è©¦
        # å„ªå…ˆé †åºï¼šFlash -> Pro -> ä»»ä½•å…¶ä»–
        selected_model = None
        for m in available_models:
            if 'flash' in m:
                selected_model = m
                break
        if not selected_model:
            for m in available_models:
                if 'gemini-pro' in m:
                    selected_model = m
                    break
        if not selected_model:
            selected_model = available_models[0]

        print(f"\nğŸ¯ è‡ªå‹•é¸æ“‡æ¸¬è©¦æ¨¡å‹ï¼š{selected_model}")
        
        # æ­¥é©Ÿ 3: ç™¼é€ Hello æ¸¬è©¦
        # æ³¨æ„ï¼šselected_model å·²ç¶“åŒ…å« 'models/' å‰ç¶´ï¼Œä¸éœ€è¦åœ¨ URL ä¸­é‡è¤‡åŠ 
        # ç¶²å€æ ¼å¼ä¿®æ­£ï¼šå¦‚æœ selected_model æ˜¯ 'models/gemini-1.5-flash'
        # URL æ‡‰è©²æ˜¯ .../v1beta/models/gemini-1.5-flash:generateContent
        # ä½†æœ‰äº› API å›å‚³çš„ name å·²ç¶“åŒ…å« models/ï¼Œæˆ‘å€‘ç›´æ¥æ¥åœ¨ v1beta/ å¾Œé¢å³å¯ï¼Œæˆ–è€…ç”¨ replace è™•ç†
        
        clean_model_name = selected_model.replace("models/", "")
        generate_url = f"https://generativelanguage.googleapis.com/v1beta/models/{clean_model_name}:generateContent?key={API_KEY}"
        
        payload = {
            "contents": [{"parts": [{"text": "Say hello"}]}]
        }
        json_data = json.dumps(payload).encode('utf-8')
        
        print(f"ğŸš€ æ­£åœ¨ç™¼é€æ¸¬è©¦è«‹æ±‚åˆ°ï¼š{clean_model_name} ...")
        
        gen_req = urllib.request.Request(generate_url, data=json_data, headers=headers)
        with urllib.request.urlopen(gen_req, context=context) as gen_response:
            gen_result = gen_response.read().decode('utf-8')
            print("\nâœ… æ¸¬è©¦æˆåŠŸï¼æ‚¨çš„ API å®Œå…¨æ­£å¸¸ï¼")
            print("-" * 30)
            parsed = json.loads(gen_result)
            print("AI å›æ‡‰ï¼š", parsed['candidates'][0]['content']['parts'][0]['text'])

    except urllib.error.HTTPError as e:
        print(f"\nâŒ HTTP éŒ¯èª¤ {e.code}:")
        print(e.read().decode('utf-8'))
    except Exception as e:
        print(f"\nâŒ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: {e}")

if __name__ == "__main__":
    list_and_test_models()