import admin from 'firebase-admin';

export default async function handler(req, res) {
  try {
    // 1. åˆå§‹åŒ– Firebase Admin (ä¿æŒåŸæœ¬çš„å¯«æ³•)
    if (!admin.apps.length) {
      if (!process.env.FIREBASE_SERVICE_ACCOUNT) {
        return res.status(500).json({ error: "âŒ æ‰¾ä¸åˆ°ç’°å¢ƒè®Šæ•¸ FIREBASE_SERVICE_ACCOUNT" });
      }
      let serviceAccount;
      try {
        serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);
      } catch (e) {
        return res.status(500).json({ error: "âŒ JSON æ ¼å¼è§£æå¤±æ•—", details: e.message });
      }
      if (serviceAccount.private_key) {
         serviceAccount.private_key = serviceAccount.private_key.replace(/\\n/g, '\n');
      }
      admin.initializeApp({
        credential: admin.credential.cert(serviceAccount)
      });
    }
    
    const db = admin.firestore();

    // ==========================================
    // ğŸŒŸ Time Tuner (æ™‚å…‰æ©Ÿæ¨¡çµ„) ğŸŒŸ
    // ==========================================
    // æª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰å¸¶åƒæ•¸ï¼Œä¾‹å¦‚: ?force=true æˆ– ?targetDate=2026-02-28
    const isForceRun = req.query.force === 'true'; 
    const targetDateStr = req.query.targetDate;

    // å¦‚æœæœ‰çµ¦å‡æ™‚é–“ï¼Œå°±ç”¨å‡æ™‚é–“ï¼›æ²’æœ‰çš„è©±å°±ç”¨çœŸå¯¦çš„ã€Œä»Šå¤©ã€
    const today = targetDateStr ? new Date(targetDateStr) : new Date();
    
    // è¨ˆç®—æ˜å¤©æ˜¯å¹¾è™Ÿ
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    
    // å¦‚æœä¸æ˜¯å¼·åˆ¶åŸ·è¡Œï¼Œä¸”æ˜å¤©ä¸æ˜¯ 1 è™Ÿ (ä»£è¡¨ä»Šå¤©ä¸æ˜¯æœˆåº•)ï¼Œå°±ä¹–ä¹–è·³é
    if (!isForceRun && tomorrow.getDate() !== 1) {
      return res.status(200).json({ message: 'å°šæœªåˆ°æœˆåº•æœ€å¾Œä¸€å¤©ï¼Œè·³éè‡ªå‹•çµç®—ã€‚' });
    }

    // ä½¿ç”¨è¨ˆç®—å‡ºçš„ã€Œç•¶å‰æ™‚é–“ã€(å¯èƒ½æ˜¯å‡æ™‚é–“) ä¾†æ±ºå®šè¦çµç®—å“ªå€‹æœˆ
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    // ==========================================

    const scheduleDocId = `${year}-${month}`; // å°‹æ‰¾ Scheduls è£¡çš„ 2026-2
    const archiveDocId = `${year}_${month}`;  // å­˜å…¥ archive_reports è£¡çš„ 2026_2

    // 3. æŠ“å–è³‡æ–™åº«
    const staffRef = db.collection('NurseApp').doc('Staff');
    const scheduleRef = db.collection('Schedules').doc(scheduleDocId);

    const [staffSnap, scheduleSnap] = await Promise.all([ staffRef.get(), scheduleRef.get() ]);

    if (!scheduleSnap.exists) {
        return res.status(404).json({ error: `âŒ æ‰¾ä¸åˆ° ${year}å¹´${month}æœˆ çš„ç­è¡¨ï¼Œç„¡æ³•çµç®—ï¼(å°‹æ‰¾çš„æ–‡æª”ID: ${scheduleDocId})` });
    }
    
    const staffData = staffSnap.data()?.staffData || [];
    const finalizedSchedule = scheduleSnap.data()?.finalizedSchedule || {};
    const baseSalary = 40000; 

    // 4. ç”¢ç”Ÿ CSV 
    let csv = "\uFEFFå·¥è™Ÿ,å§“å,1è™Ÿ...[ç•¥],å¥åº·åº¦,ç¸½å·¥æ™‚,åŠ ç­è²»,é ä¼°ç¸½è–ªè³‡\n";
    
    Object.keys(finalizedSchedule).forEach(staffId => {
      if (staffId.startsWith('D')) return;
      const staff = staffData.find(s => s.staff_id === staffId);
      const name = staff?.name || "æœªçŸ¥";
      const schedule = finalizedSchedule[staffId];
      
      let workDays = 0, nightCount = 0;
      Object.values(schedule).forEach(cell => {
        const type = (typeof cell === 'object') ? cell.type : cell;
        if (['D', 'E', 'N', 'æ”¯æ´'].includes(type)) workDays++;
        if (type === 'N') nightCount++;
      });

      const totalSalary = baseSalary + (nightCount * 500); 
      csv += `${staffId},${name},...,90,${workDays},0,${totalSalary}\n`;
    });

    // 5. ä¸Šå‚³è‡³æ­·å²åº«
    await db.collection('archive_reports').doc(archiveDocId).set({
      csv: csv,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      autoGenerated: true
    });

    return res.status(200).json({ success: true, message: `âœ… [TimeTuner: ${year}-${month}] è‡ªå‹•çµç®—ä¸Šå‚³æˆåŠŸï¼` });

  } catch (error) {
    console.error("âŒ ä¼ºæœå™¨å´©æ½°:", error);
    return res.status(500).json({ error: "âŒ ä¼ºæœå™¨åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤", details: error.message });
  }
}