import admin from 'firebase-admin';

export default async function handler(req, res) {
  try {
    // 1. 初始化包在 try 裡面，這樣報錯就會直接顯示在網頁上！
    if (!admin.apps.length) {
      if (!process.env.FIREBASE_SERVICE_ACCOUNT) {
        return res.status(500).json({ error: "❌ 找不到環境變數 FIREBASE_SERVICE_ACCOUNT" });
      }
      
      let serviceAccount;
      try {
        serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);
      } catch (e) {
        return res.status(500).json({ error: "❌ JSON 格式解析失敗，請確認 Vercel 變數內容是否為完整 JSON。", details: e.message });
      }

      // 替換換行符號
      if (serviceAccount.private_key) {
         serviceAccount.private_key = serviceAccount.private_key.replace(/\\n/g, '\n');
      }

      admin.initializeApp({
        credential: admin.credential.cert(serviceAccount)
      });
    }
    
    const db = admin.firestore();

    // 2. 檢查是否為月底最後一天 (測試時如果想強制執行，可以把這段註解掉)
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    
    if (tomorrow.getDate() !== 1) {
      return res.status(200).json({ message: '尚未到月底最後一天，跳過自動結算。' });
    }

const year = today.getFullYear();
    const month = today.getMonth() + 1;
    
    // 尋找班表的 ID (對應您資料庫的連字號)
    const scheduleDocId = `${year}-${month}`; 
    
    // 存入報表庫的 ID (保持底線，配合前端解析)
    const archiveDocId = `${year}_${month}`; 

    // 3. 抓取資料庫
    const staffRef = db.collection('NurseApp').doc('Staff');
    const scheduleRef = db.collection('Schedules').doc(scheduleDocId);

    const [staffSnap, scheduleSnap] = await Promise.all([ staffRef.get(), scheduleRef.get() ]);

    if (!scheduleSnap.exists) {
        return res.status(404).json({ error: `❌ 找不到 ${year}年${month}月 的班表，無法結算！(尋找的文檔ID: ${scheduleDocId})` });
    }
    
    const staffData = staffSnap.data()?.staffData || [];
    const finalizedSchedule = scheduleSnap.data()?.finalizedSchedule || {};
    const baseSalary = 40000; 

    // 4. 產生 CSV 
    let csv = "\uFEFF工號,姓名,1號...[略],健康度,總工時,加班費,預估總薪資\n";
    
    Object.keys(finalizedSchedule).forEach(staffId => {
      if (staffId.startsWith('D')) return;
      const staff = staffData.find(s => s.staff_id === staffId);
      const name = staff?.name || "未知";
      const schedule = finalizedSchedule[staffId];
      
      let workDays = 0, nightCount = 0;
      Object.values(schedule).forEach(cell => {
        const type = (typeof cell === 'object') ? cell.type : cell;
        if (['D', 'E', 'N', '支援'].includes(type)) workDays++;
        if (type === 'N') nightCount++;
      });

      const totalSalary = baseSalary + (nightCount * 500); 
      csv += `${staffId},${name},...,90,${workDays},0,${totalSalary}\n`;
    });

    // 5. 上傳至歷史庫
await db.collection('archive_reports').doc(archiveDocId).set({
      csv: csv,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      autoGenerated: true
    });

    return res.status(200).json({ success: true, message: `✅ ${docId} 自動結算上傳成功！` });

  } catch (error) {
    console.error("❌ 伺服器崩潰:", error);
    return res.status(500).json({ error: "❌ 伺服器執行時發生錯誤", details: error.message });
  }
}